/**
 * æ•°æ®å¯è§†åŒ–ç»„ä»¶ - çº¯JavaScripté€»è¾‘
 * æ”¯æŒå¤šæµ‹ç‚¹å¯¹æ¯”ã€é™é‡‡æ ·ã€åˆ†é¡µè¡¨æ ¼ç­‰åŠŸèƒ½
 */
class DataVisualization extends HTMLElement {
    constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.chart = null;
        this.selectedPoints = new Set();
        this.allData = [];
        this.displayData = [];
        this.currentPage = 1;
        this.pageSize = 20;
        this.totalPages = 0;
        this.dataSource = '';
        this.availablePoints = [];
    }

    async connectedCallback() {
        await this.loadResources();
        setTimeout(() => {
            this.bindEvents();
        }, 100);
    }

    async loadResources() {
        // åŠ è½½CSS
        try {
            const cssLink = document.createElement('link');
            cssLink.rel = 'stylesheet';
            cssLink.href = './components/data-visualization/data-visualization.css';
            this.shadowRoot.appendChild(cssLink);
        } catch (error) {
            console.error('Failed to load CSS:', error);
        }

        if (window.location.protocol === 'file:') {
            this.shadowRoot.innerHTML += this.getFallbackHTML();
        } else {

        // åŠ è½½HTML
            try {
                const response = await fetch('./components/data-visualization/data-visualization.html');
                const html = await response.text();
                this.shadowRoot.innerHTML += html;
            } catch (error) {
                console.error('Failed to load HTML:', error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…åµŒHTMLä½œä¸ºåå¤‡
                this.shadowRoot.innerHTML += this.getFallbackHTML();
            }
        }

        // åŠ è½½EChartsåˆ°å…¨å±€
        try {
            if (!window.echarts) {
                const script = document.createElement('script');
                script.src = './lib/echarts/echarts.min.js';
                document.head.appendChild(script);
                
                // ç­‰å¾…EChartsåŠ è½½å®Œæˆ
                await new Promise((resolve) => {
                    script.onload = resolve;
                });
            }
        } catch (error) {
            console.error('Failed to load ECharts:', error);
        }
    }

    getFallbackHTML() {
        return `
        <div class="visualization-container">
            <div class="visualization-header">
                <h3 class="visualization-title" id="dataSourceName">æ—¶åºæ•°æ®æŸ¥è¯¢</h3>
                <button class="close-btn" id="closeBtn">Ã—</button>
            </div>
            
            <div class="content-area">
                <div class="chart-section">
                    <div class="chart-header">
                        <h4 class="chart-title">è¶‹åŠ¿å›¾</h4>
                    </div>
                    <div class="chart-container" id="chartContainer">
                        <!-- EChartså›¾è¡¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                    </div>
                </div>
                
                <div class="operations-section">
                    <div class="operations-header">
                        <h4 class="operations-title">æ“ä½œ</h4>
                        <div class="operations-actions">
                            <button class="action-btn" id="dataCleanBtn">æ•°æ®æ¸…ç†</button>
                            <button class="action-btn" id="importBtn">å¯¼å…¥æ•°æ®</button>
                            <button class="action-btn" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
                        </div>
                    </div>
                    <div class="operations-content">
                        <div class="query-controls">
                            <div class="query-row">
                                <div class="query-item">
                                    <label class="query-label">å¼€å§‹æ—¶é—´</label>
                                    <input type="datetime-local" class="query-input" id="startTime">
                                </div>
                                <div class="query-item">
                                    <label class="query-label">ç»“æŸæ—¶é—´</label>
                                    <input type="datetime-local" class="query-input" id="endTime">
                                </div>
                                <div class="query-item">
                                    <label class="query-label">èšåˆå‡½æ•°</label>
                                    <select class="query-select" id="aggregationFunction">
                                        <option value="raw">åŸå§‹æ•°æ®</option>
                                        <option value="avg">å¹³å‡å€¼</option>
                                        <option value="max">æœ€å¤§å€¼</option>
                                        <option value="min">æœ€å°å€¼</option>
                                        <option value="sum">æ±‚å’Œ</option>
                                        <option value="count">è®¡æ•°</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="query-row">
                                <div class="query-item">
                                    <label class="query-label">å¿«é€Ÿé€‰æ‹©</label>
                                    <div class="quick-time-buttons">
                                        <button class="quick-time-btn" data-range="1h">æœ€è¿‘1å°æ—¶</button>
                                        <button class="quick-time-btn" data-range="6h">æœ€è¿‘6å°æ—¶</button>
                                        <button class="quick-time-btn" data-range="24h">æœ€è¿‘24å°æ—¶</button>
                                        <button class="quick-time-btn" data-range="7d">æœ€è¿‘7å¤©</button>
                                    </div>
                                </div>
                                <div class="query-actions">
                                    <button class="query-btn" id="queryBtn">æŸ¥è¯¢æ•°æ®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-section">
                    <div class="table-header">
                        <span class="table-title">æ•°æ®åˆ—è¡¨</span>
                        <div class="selected-points-in-header">
                            <span class="selected-points-label">å·²é€‰æµ‹ç‚¹:</span>
                            <div class="selected-points-compact" id="selectedPointsList">
                                <!-- åŠ¨æ€ç”Ÿæˆå·²é€‰æµ‹ç‚¹åˆ—è¡¨ -->
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <!-- åŠ¨æ€ç”Ÿæˆæµ‹ç‚¹åˆ—å¤´ -->
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- åŠ¨æ€ç”Ÿæˆè¡¨æ ¼æ•°æ® -->
                            </tbody>
                        </table>
                        <div class="pagination">
                            <div class="pagination-left">
                                <div class="page-size-selector">
                                    <span>æ¯é¡µæ˜¾ç¤º</span>
                                    <select class="page-size-select" id="pageSizeSelect">
                                        <option value="10">10æ¡</option>
                                        <option value="20" selected>20æ¡</option>
                                        <option value="50">50æ¡</option>
                                        <option value="100">100æ¡</option>
                                    </select>
                                </div>
                                <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                            </div>
                            <div class="pagination-right">
                                <button id="prevBtn">ä¸Šä¸€é¡µ</button>
                                <button id="nextBtn">ä¸‹ä¸€é¡µ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    show(dataSource, points = [], tableData = null, keepQueryConditions = false) {
        console.log('æ˜¾ç¤ºæ•°æ®å¯è§†åŒ–:', dataSource, points, tableData, 'ä¿æŒæŸ¥è¯¢æ¡ä»¶:', keepQueryConditions);
        this.setAttribute('show', '');
        this.dataSource = dataSource;
        this.availablePoints = points;
        // å¦‚æœæ˜¯æ–°çš„æ˜¾ç¤ºï¼Œä½¿ç”¨ä¼ å…¥çš„æµ‹ç‚¹ï¼›å¦‚æœæ˜¯å·²å­˜åœ¨çš„ç»„ä»¶ï¼Œä¿æŒå½“å‰é€‰ä¸­çš„æµ‹ç‚¹
        if (!this.selectedPoints || this.selectedPoints.size === 0) {
            this.selectedPoints = new Set(points);
        }
        
        // è®¾ç½®æ•°æ®æºåç§°
        const dataSourceNameEl = this.shadowRoot.getElementById('dataSourceName');
        if (dataSourceNameEl) {
            dataSourceNameEl.textContent = 'æ—¶åºæ•°æ®æŸ¥è¯¢';
        }
        
        console.log('ç»„ä»¶å·²æ˜¾ç¤ºï¼Œå¼€å§‹åˆå§‹åŒ–...');
        
        // å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€
        setTimeout(() => {
            // æ›´æ–°å·²é€‰æµ‹ç‚¹åˆ—è¡¨
            this.updateSelectedPointsList();
            
            // è®¾ç½®é»˜è®¤çš„å¿«é€Ÿé€‰æ‹©ä¸ºæœ€è¿‘1å°æ—¶ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ï¼‰
            console.log('ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦è®¾ç½®é»˜è®¤æ—¶é—´èŒƒå›´ï¼ŒkeepQueryConditions:', keepQueryConditions);
            if (!keepQueryConditions) {
                console.log('âœ… è°ƒç”¨ setDefaultTimeRange()');
                this.setDefaultTimeRange();
            } else {
                console.log('âŒ è·³è¿‡ setDefaultTimeRange()ï¼Œä¿æŒç°æœ‰æŸ¥è¯¢æ¡ä»¶');
            }
            
            // å¦‚æœæœ‰ä¼ å…¥çš„æ•°æ®ï¼Œå¤„ç†å®ƒ
            if (tableData) {
                console.log('å¤„ç†ä¼ å…¥çš„è¡¨æ ¼æ•°æ®:', tableData);
                this.processTableData(tableData);
            } else {
                // å¦åˆ™è°ƒç”¨loadDataè·å–æ•°æ®
                this.loadData();
            }
            
            // ç»‘å®šæŸ¥è¯¢æ§ä»¶äº‹ä»¶
            this.bindQueryEvents();
            
            // å¼ºåˆ¶è§¦å‘é‡æ–°å¸ƒå±€
            this.updateLayout();
        }, 50);
    }

    // è®¾ç½®é»˜è®¤æ—¶é—´èŒƒå›´ä¸ºæœ€è¿‘1å°æ—¶
    setDefaultTimeRange() {
        console.log('âš ï¸ setDefaultTimeRange() è¢«è°ƒç”¨äº†ï¼');
        const endTime = new Date();
        const startTime = new Date();
        startTime.setHours(startTime.getHours() - 1);
        
        const startTimeInput = this.shadowRoot.getElementById('startTime');
        const endTimeInput = this.shadowRoot.getElementById('endTime');
        const quickTimeBtns = this.shadowRoot.querySelectorAll('.quick-time-btn');
        
        if (startTimeInput) {
            startTimeInput.value = startTime.toISOString().slice(0, 16);
        }
        if (endTimeInput) {
            endTimeInput.value = endTime.toISOString().slice(0, 16);
        }
        
        // è®¾ç½®å¿«é€Ÿé€‰æ‹©æŒ‰é’®çš„é»˜è®¤çŠ¶æ€
        quickTimeBtns.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.range === '1h') {
                btn.classList.add('active');
            }
        });
    }

    // å¤„ç†è¡¨æ ¼æ•°æ®
    processTableData(tableData) {
        console.log('å¤„ç†è¡¨æ ¼æ•°æ®:', tableData);
        
        if (!tableData || !tableData.header || !tableData.records) {
            console.error('æ— æ•ˆçš„è¡¨æ ¼æ•°æ®æ ¼å¼');
            this.showEmptyState();
            return;
        }
        
        // é‡ç½®åˆ†é¡µçŠ¶æ€
        this.currentPage = 1;
        this.pageSize = 20;
        
        // è®¾ç½®è¡¨å¤´ï¼ˆæ¯æ¬¡æ¥å£è°ƒç”¨éƒ½è¦æ›´æ–°ï¼‰
        this.updateTableHeader(tableData.header);
        
        // ä¿å­˜å®é™…çš„æ•°æ®åˆ—ï¼ˆç”¨äºè¡¨æ ¼æ˜¾ç¤ºï¼‰
        this.actualDataColumns = tableData.header.filter(col => col !== 'Time');
        
        // ä¿å­˜è¡¨å¤´ä¿¡æ¯ï¼ˆç”¨äºæ—¶é—´åˆ—æ£€æµ‹ï¼‰
        this.tableHeader = tableData.header;
        
        // å¤„ç†æ•°æ®è®°å½•
        this.allData = tableData.records.map(record => {
            const processedRecord = { ...record };
            
            // å¦‚æœæœ‰Timeåˆ—ï¼Œè½¬æ¢ä¸ºæ—¶é—´æˆ³ï¼Œè§£æå¤±è´¥åˆ™è·³è¿‡è¿™æ¡æ•°æ®
            if (record.Time) {
                try {
                    processedRecord.timestamp = new Date(record.Time).getTime();
                    // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦æœ‰æ•ˆ
                    if (isNaN(processedRecord.timestamp)) {
                        console.warn('æ—¶é—´è§£æå¤±è´¥ï¼Œè·³è¿‡æ•°æ®:', record.Time);
                        return null; // è¿”å›nullè¡¨ç¤ºè·³è¿‡è¿™æ¡æ•°æ®
                    }
                } catch (error) {
                    console.warn('æ—¶é—´è§£æå¼‚å¸¸ï¼Œè·³è¿‡æ•°æ®:', record.Time, error);
                    return null; // è¿”å›nullè¡¨ç¤ºè·³è¿‡è¿™æ¡æ•°æ®
                }
            }
            
            return processedRecord;
        }).filter(record => record !== null); // è¿‡æ»¤æ‰nullè®°å½•
        
        console.log('å¤„ç†åçš„æ•°æ®:', this.allData.length, 'æ¡è®°å½•');
        
        // åº”ç”¨é™é‡‡æ ·
        this.applyDownsampling();
        
        // æ›´æ–°è¡¨æ ¼
        this.updateTable();
        
        // åˆå§‹åŒ–å›¾è¡¨
        if (!this.chart) {
            this.initChart();
        } else {
            this.updateVisualization();
        }
        
        // æ›´æ–°å·²é€‰æµ‹ç‚¹åˆ—è¡¨
        this.updateSelectedPointsList();
        
        // ç»‘å®šæŸ¥è¯¢æ§ä»¶äº‹ä»¶ï¼ˆç¡®ä¿æŒ‰é’®å¯ä»¥ç‚¹å‡»ï¼‰
        // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œé‡å¤ç»‘å®šï¼Œå·²ç»åœ¨show()ä¸­ç»‘å®šäº†
        // this.bindQueryEvents();
    }

    // æ›´æ–°è¡¨å¤´
    updateTableHeader(header) {
        const table = this.shadowRoot.getElementById('dataTable');
        const tableHead = table ? table.querySelector('thead tr') : null;
        if (tableHead) {
            // æ¸…ç©ºç°æœ‰è¡¨å¤´
            tableHead.innerHTML = '';
            
            // æ·»åŠ æ‰€æœ‰åˆ—å¤´ï¼ŒåŒ…æ‹¬Timeåˆ—
            header.forEach(columnName => {
                const th = document.createElement('th');
                th.textContent = columnName;
                tableHead.appendChild(th);
            });
        }
    }

    hide() {
        console.log('éšè—æ•°æ®å¯è§†åŒ–');
        this.removeAttribute('show');
        if (this.chart) {
            this.chart.dispose();
            this.chart = null;
        }
    }

    updateLayout() {
        // å¼ºåˆ¶é‡æ–°è®¡ç®—å°ºå¯¸
        const chartContainer = this.shadowRoot.getElementById('chartContainer');
        if (chartContainer) {
            chartContainer.style.display = 'none';
            chartContainer.offsetHeight; // è§¦å‘é‡æ’
            chartContainer.style.display = '';
            
            // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œå¼ºåˆ¶é‡æ–°è°ƒæ•´å¤§å°
            if (this.chart) {
                setTimeout(() => {
                    this.chart.resize();
                }, 100);
            }
        }
    }

    bindEvents() {
        // å…³é—­æŒ‰é’®
        const closeBtn = this.shadowRoot.getElementById('closeBtn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.hide();
            });
        }

        // æ•°æ®æ¸…ç†æŒ‰é’®
        const dataCleanBtn = this.shadowRoot.getElementById('dataCleanBtn');
        if (dataCleanBtn) {
            dataCleanBtn.addEventListener('click', () => {
                this.showDataCleanModal();
            });
        }

        // å¯¼å…¥æ•°æ®æŒ‰é’®
        const importBtn = this.shadowRoot.getElementById('importBtn');
        if (importBtn) {
            importBtn.addEventListener('click', () => {
                // ä½¿ç”¨å…¨å±€showComponentå‡½æ•°
                if (typeof window.showComponent === 'function') {
                    window.showComponent('importData');
                } else {
                    console.error('window.showComponentå‡½æ•°æœªæ‰¾åˆ°');
                }
            });
        }

        // å¯¼å‡ºæ•°æ®æŒ‰é’®
        const exportBtn = this.shadowRoot.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                this.showExportModal();
            });
        }

        // åˆ†é¡µç»„ä»¶
        const pagination = this.shadowRoot.getElementById('tablePagination');
        if (pagination) {
            pagination.addEventListener('pagination-change', (e) => {
                this.currentPage = e.detail.currentPage;
                this.pageSize = e.detail.pageSize;
                this.updateTable();
            });
        }

        // ESCé”®å…³é—­
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.hasAttribute('show')) {
                this.hide();
            }
        });
    }

    bindQueryEvents() {
        console.log('ç»‘å®šæŸ¥è¯¢æ§ä»¶äº‹ä»¶...');
        
        // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
        const queryBtn = this.shadowRoot.getElementById('queryBtn');
        if (queryBtn) {
            // å…‹éš†æŒ‰é’®æ¥ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
            const newQueryBtn = queryBtn.cloneNode(true);
            queryBtn.parentNode.replaceChild(newQueryBtn, queryBtn);
        }
        
        // ç»‘å®šå¿«é€Ÿæ—¶é—´æŒ‰é’®
        const quickTimeBtns = this.shadowRoot.querySelectorAll('.quick-time-btn');
        console.log('æ‰¾åˆ°å¿«é€Ÿæ—¶é—´æŒ‰é’®:', quickTimeBtns.length);
        quickTimeBtns.forEach(btn => {
            // å…‹éš†æŒ‰é’®æ¥ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            btn = newBtn;
            
            btn.addEventListener('click', () => {
                console.log('å¿«é€Ÿæ—¶é—´æŒ‰é’®è¢«ç‚¹å‡»:', btn.dataset.range);
                // é‡æ–°è·å–æ‰€æœ‰æŒ‰é’®å¹¶ç§»é™¤activeçŠ¶æ€
                const allBtns = this.shadowRoot.querySelectorAll('.quick-time-btn');
                allBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const range = btn.dataset.range;
                const endTime = new Date();
                const startTime = new Date();
                
                switch (range) {
                    case '1h':
                        startTime.setHours(startTime.getHours() - 1);
                        break;
                    case '6h':
                        startTime.setHours(startTime.getHours() - 6);
                        break;
                    case '24h':
                        startTime.setDate(startTime.getDate() - 1);
                        break;
                    case '7d':
                        startTime.setDate(startTime.getDate() - 7);
                        break;
                }
                
                const startTimeInput = this.shadowRoot.getElementById('startTime');
                const endTimeInput = this.shadowRoot.getElementById('endTime');
                
                if (startTimeInput) {
                    startTimeInput.value = startTime.toISOString().slice(0, 16);
                }
                if (endTimeInput) {
                    endTimeInput.value = endTime.toISOString().slice(0, 16);
                }
            });
        });

        // ç»‘å®šæŸ¥è¯¢æŒ‰é’®
        const queryBtnNew = this.shadowRoot.getElementById('queryBtn');
        console.log('æ‰¾åˆ°æŸ¥è¯¢æŒ‰é’®:', queryBtnNew);
        if (queryBtnNew) {
            queryBtnNew.addEventListener('click', () => {
                console.log('æŸ¥è¯¢æŒ‰é’®è¢«ç‚¹å‡»');
                this.loadData();
            });
        }

        // ç»‘å®šé‡ç½®æŒ‰é’®
        const resetBtn = this.shadowRoot.getElementById('resetBtn');
        console.log('æ‰¾åˆ°é‡ç½®æŒ‰é’®:', resetBtn);
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                console.log('é‡ç½®æŒ‰é’®è¢«ç‚¹å‡»');
                this.resetQueryForm();
            });
        }
    }

    // é‡ç½®æŸ¥è¯¢è¡¨å•
    resetQueryForm() {
        console.log('é‡ç½®æŸ¥è¯¢è¡¨å•');
        
        // æ¸…ç©ºæ—¶é—´è¾“å…¥æ¡†
        const startTimeInput = this.shadowRoot.getElementById('startTime');
        const endTimeInput = this.shadowRoot.getElementById('endTime');
        
        if (startTimeInput) {
            startTimeInput.value = '';
        }
        if (endTimeInput) {
            endTimeInput.value = '';
        }
        
        // é‡ç½®èšåˆå‡½æ•°ä¸ºåŸå§‹æ•°æ®
        const aggregationSelect = this.shadowRoot.getElementById('aggregationFunction');
        if (aggregationSelect) {
            aggregationSelect.value = '';
        }
        
        // é‡ç½®æ—¶é—´é—´éš”ä¸ºç©º
        const precisionInput = this.shadowRoot.getElementById('precision');
        if (precisionInput) {
            precisionInput.value = '';
        }
        
        // é‡ç½®æ—¶é—´å•ä½ä¸ºæ¯«ç§’
        const timePrecisionSelect = this.shadowRoot.getElementById('timePrecision');
        if (timePrecisionSelect) {
            timePrecisionSelect.value = '7'; // é»˜è®¤æ¯«ç§’
        }
        
        // æ¸…é™¤å¿«é€Ÿé€‰æ‹©æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
        const quickTimeBtns = this.shadowRoot.querySelectorAll('.quick-time-btn');
        quickTimeBtns.forEach(btn => {
            btn.classList.remove('active');
        });
        
        // ä¸é‡æ–°è®¾ç½®é»˜è®¤æ—¶é—´ï¼Œä¿æŒæ¸…ç©ºçŠ¶æ€
        // ä¸è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æŸ¥è¯¢
    }

    updateSelectedPointsList() {
        const selectedPointsList = this.shadowRoot.getElementById('selectedPointsList');
        if (!selectedPointsList) return;

        selectedPointsList.innerHTML = '';
        
        if (this.selectedPoints.size === 0) {
            selectedPointsList.innerHTML = '<span style="color: #999; font-size: 12px;">æš‚æ— é€‰ä¸­çš„æµ‹ç‚¹</span>';
            return;
        }

        this.selectedPoints.forEach(point => {
            const pointItem = document.createElement('div');
            pointItem.className = 'selected-point-item';
            pointItem.innerHTML = `
                <span class="selected-point-name">${point}</span>
                <button class="remove-point" data-point="${point}">Ã—</button>
            `;
            
            // ç»‘å®šç§»é™¤äº‹ä»¶
            const removeBtn = pointItem.querySelector('.remove-point');
            removeBtn.addEventListener('click', () => {
                this.removeSelectedPoint(point);
            });
            
            selectedPointsList.appendChild(pointItem);
        });
    }

    removeSelectedPoint(point) {
        console.log('ç§»é™¤æµ‹ç‚¹:', point);
        this.selectedPoints.delete(point);
        
        // æ›´æ–°å…¨å±€é€‰ä¸­çš„æµ‹ç‚¹
        if (window.selectedDataPoints) {
            window.selectedDataPoints.delete(point);
        }
        
        // æ›´æ–°æ˜¾ç¤º
        this.updateSelectedPointsList();
        
        // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„æµ‹ç‚¹äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        if (this.selectedPoints.size === 0) {
            console.log('æ²¡æœ‰é€‰ä¸­çš„æµ‹ç‚¹äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
            this.showEmptyState();
        } else {
            // è°ƒç”¨æ¥å£é‡æ–°æŸ¥è¯¢æ•°æ®ï¼Œç¡®ä¿è¡¨å¤´å’Œæ•°æ®éƒ½æ˜¯æœ€æ–°çš„
            this.loadData();
        }
    }

    // é‡æ–°è®¡ç®—æ˜¾ç¤ºæ•°æ®ï¼Œä¸è°ƒç”¨æ¥å£
    recalculateDisplayData() {
        if (this.allData.length === 0) {
            return;
        }
        
        // é‡æ–°åº”ç”¨é™é‡‡æ ·å’Œæ›´æ–°æ˜¾ç¤º
        this.applyDownsampling();
        
        // æ›´æ–°è¡¨æ ¼ï¼ˆåŒ…æ‹¬è¡¨å¤´ï¼‰
        this.updateTable();
        
        // æ›´æ–°å›¾è¡¨
        if (this.chart) {
            this.updateVisualization();
        }
    }

    async loadData() {
        try {
            console.log('å¼€å§‹åŠ è½½æ•°æ®ï¼Œé€‰ä¸­çš„æµ‹ç‚¹:', Array.from(this.selectedPoints));
            console.log('selectedPoints size:', this.selectedPoints.size);
            
            // æ˜¾ç¤ºå…¨å±€loading
            if (window.showGlobalLoading) {
                window.showGlobalLoading('æ­£åœ¨æŸ¥è¯¢æ•°æ®...');
            }
            
            if (this.selectedPoints.size === 0) {
                console.log('æ²¡æœ‰é€‰ä¸­çš„æµ‹ç‚¹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                if (window.hideGlobalLoading) {
                    window.hideGlobalLoading();
                }
                this.showEmptyState();
                return;
            }
            
            // è·å–æŸ¥è¯¢å‚æ•°
            const startTimeInput = this.shadowRoot.getElementById('startTime');
            const endTimeInput = this.shadowRoot.getElementById('endTime');
            const aggregationSelect = this.shadowRoot.getElementById('aggregationFunction');
            const precisionInput = this.shadowRoot.getElementById('precision');
            const timePrecisionSelect = this.shadowRoot.getElementById('timePrecision');
            
            let startTime = null;
            let endTime = null;
            let aggregateType = null;
            let precision = null; // ä¸è®¾ç½®é»˜è®¤å€¼ï¼Œè®©åç«¯å¤„ç†
            let timePrecision = 7; // é»˜è®¤æ¯«ç§’
            
            // å¤„ç†æ—¶é—´å‚æ•°
            if (startTimeInput && startTimeInput.value) {
                startTime = new Date(startTimeInput.value).getTime();
            }
            if (endTimeInput && endTimeInput.value) {
                endTime = new Date(endTimeInput.value).getTime();
            }
            
            // å¦‚æœæ²¡æœ‰è®¾ç½®æ—¶é—´ï¼Œä½†æœ‰å¿«é€Ÿé€‰æ‹©çš„æ—¶é—´ï¼Œä½¿ç”¨å¿«é€Ÿé€‰æ‹©çš„æ—¶é—´
            if (startTime === null && endTime === null) {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¿«é€Ÿé€‰æ‹©æŒ‰é’®è¢«é€‰ä¸­
                const activeQuickBtn = this.shadowRoot.querySelector('.quick-time-btn.active');
                if (activeQuickBtn) {
                    const range = activeQuickBtn.dataset.range;
                    const endTime = new Date();
                    const startTime = new Date();
                    
                    switch (range) {
                        case '1h':
                            startTime.setHours(startTime.getHours() - 1);
                            break;
                        case '6h':
                            startTime.setHours(startTime.getHours() - 6);
                            break;
                        case '24h':
                            startTime.setHours(startTime.getHours() - 24);
                            break;
                        case '7d':
                            startTime.setDate(startTime.getDate() - 7);
                            break;
                    }
                    
                    startTime = startTime.getTime();
                    endTime = endTime.getTime();
                }
            }
            
            // å¤„ç†èšåˆå‡½æ•°å‚æ•°
            if (aggregationSelect && aggregationSelect.value) {
                aggregateType = parseInt(aggregationSelect.value);
            }
            
            // å¤„ç†æ—¶é—´é—´éš”å‚æ•°
            if (precisionInput && precisionInput.value) {
                precision = parseInt(precisionInput.value);
            }
            
            // å¤„ç†æ—¶é—´å•ä½å‚æ•°
            if (timePrecisionSelect && timePrecisionSelect.value) {
                timePrecision = parseInt(timePrecisionSelect.value);
            }
            
            console.log('æŸ¥è¯¢å‚æ•°:', { startTime, endTime, aggregateType, precision, timePrecision });
            
            // æ„å»ºè¯·æ±‚ä½“
            const requestBody = {
                paths: Array.from(this.selectedPoints),
                startTime: startTime,
                endTime: endTime,
                aggregateType: aggregateType,
                timePrecision: timePrecision
            };
            
            // åªæœ‰å½“precisionä¸ä¸ºnullæ—¶æ‰æ·»åŠ precisionå‚æ•°
            if (precision !== null) {
                requestBody.precision = precision;
            }
            
            // è°ƒç”¨æ•°æ®æŸ¥è¯¢æ¥å£
            const response = await fetch(window.AppConfig.getApiUrl('data', 'query'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            const result = await response.json();
            
            if (result.code === 200 && result.data) {
                console.log('æ•°æ®æŸ¥è¯¢æˆåŠŸ:', result.data);
                
                // å¤„ç†æŸ¥è¯¢ç»“æœ
                this.processTableData(result.data);
            } else if (result.code === 200 && (!result.data || !result.data.records || result.data.records.length === 0)) {
                // æ¥å£æˆåŠŸä½†æ²¡æœ‰æ•°æ®
                console.log('æŸ¥è¯¢æˆåŠŸä½†æ²¡æœ‰æ•°æ®');
                this.showEmptyState();
            } else {
                // æ¥å£è¿”å›é”™è¯¯
                console.error('æ•°æ®æŸ¥è¯¢å¤±è´¥:', result.message);
                this.showError('æ•°æ®æŸ¥è¯¢å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
            
        } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            this.showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•æŸ¥è¯¢æ•°æ®');
        } finally {
            // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½éšè—å…¨å±€loading
            if (window.hideGlobalLoading) {
                window.hideGlobalLoading();
            }
        }
    }

    // æ˜¾ç¤ºloadingæ•ˆæœ
    showLoading() {
        console.log('æ˜¾ç¤ºloadingæ•ˆæœ');
        
        // åœ¨è¡¨æ ¼åŒºåŸŸæ˜¾ç¤ºloading
        const tableSection = this.shadowRoot.querySelector('.table-section');
        if (tableSection) {
            tableSection.style.position = 'relative';
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨loadingå…ƒç´ 
            let loadingEl = tableSection.querySelector('.loading-overlay');
            if (!loadingEl) {
                loadingEl = document.createElement('div');
                loadingEl.className = 'loading-overlay';
                loadingEl.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</div>
                    </div>
                `;
                tableSection.appendChild(loadingEl);
            }
        }
        
        // ç¦ç”¨æŸ¥è¯¢å’Œé‡ç½®æŒ‰é’®
        const queryBtn = this.shadowRoot.getElementById('queryBtn');
        const resetBtn = this.shadowRoot.getElementById('resetBtn');
        if (queryBtn) queryBtn.disabled = true;
        if (resetBtn) resetBtn.disabled = true;
    }

    // éšè—loadingæ•ˆæœ
    hideLoading() {
        console.log('éšè—loadingæ•ˆæœ');
        
        // ç§»é™¤loadingå…ƒç´ 
        const tableSection = this.shadowRoot.querySelector('.table-section');
        if (tableSection) {
            const loadingEl = tableSection.querySelector('.loading-overlay');
            if (loadingEl) {
                loadingEl.remove();
            }
        }
        
        // å¯ç”¨æŸ¥è¯¢å’Œé‡ç½®æŒ‰é’®
        const queryBtn = this.shadowRoot.getElementById('queryBtn');
        const resetBtn = this.shadowRoot.getElementById('resetBtn');
        if (queryBtn) queryBtn.disabled = false;
        if (resetBtn) resetBtn.disabled = false;
    }

    showEmptyState() {
        // æ¸…ç†EChartså®ä¾‹
        if (this.chart) {
            this.chart.dispose();
            this.chart = null;
        }
        
        const chartContainer = this.shadowRoot.getElementById('chartContainer');
        if (chartContainer) {
            chartContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
                    <div style="font-size: 14px; margin-bottom: 8px;">æš‚æ— æ•°æ®</div>
                    <div style="font-size: 12px;">è¯·åœ¨å·¦ä¾§é€‰æ‹©æµ‹ç‚¹åç‚¹å‡»æŸ¥è¯¢</div>
                </div>
            `;
        }
        
        // ç¡®ä¿è¡¨æ ¼åŒºåŸŸæ˜¾ç¤ºå¹¶æ›´æ–°ä¸ºç©ºçŠ¶æ€
        this.updateTable();
    }

    showError(message) {
        const chartContainer = this.shadowRoot.getElementById('chartContainer');
        if (chartContainer) {
            chartContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #ff4d4f;">
                    <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                    <div style="font-size: 14px;">${message}</div>
                </div>
            `;
        }
    }

    showMessage(message, type = 'info') {
        // ä½¿ç”¨å…¨å±€çš„toastæç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (window.CommonUtils && window.CommonUtils.showToast) {
            window.CommonUtils.showToast(message, type);
            return;
        }

        // é™çº§æ–¹æ¡ˆï¼šåœ¨ç»„ä»¶å†…æ˜¾ç¤ºä¸´æ—¶æç¤º
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            z-index: 10000;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        `;

        // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
        switch (type) {
            case 'success':
                toast.style.backgroundColor = '#52c41a';
                break;
            case 'error':
                toast.style.backgroundColor = '#ff4d4f';
                break;
            case 'warning':
                toast.style.backgroundColor = '#faad14';
                break;
            default:
                toast.style.backgroundColor = '#1890ff';
        }

        toast.textContent = message;
        document.body.appendChild(toast);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    generateMockData() {
        const data = [];
        const now = Date.now();
        const selectedPointsArray = Array.from(this.selectedPoints);
        
        console.log('ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼Œæµ‹ç‚¹æ•°é‡:', selectedPointsArray.length, 'æµ‹ç‚¹åˆ—è¡¨:', selectedPointsArray);
        
        if (selectedPointsArray.length === 0) {
            console.log('æ²¡æœ‰é€‰ä¸­çš„æµ‹ç‚¹ï¼Œè¿”å›ç©ºæ•°æ®');
            return [];
        }
        
        // ç”Ÿæˆ1000ä¸ªæ•°æ®ç‚¹
        for (let i = 0; i < 1000; i++) {
            const record = {
                timestamp: now - (1000 - i) * 1000, // æ¯ç§’ä¸€ä¸ªæ•°æ®ç‚¹
                values: {}
            };
            
            // ä¸ºæ¯ä¸ªé€‰ä¸­çš„æµ‹ç‚¹ç”Ÿæˆæ•°æ®
            selectedPointsArray.forEach((pointName, index) => {
                // ä¸ºä¸åŒæµ‹ç‚¹ç”Ÿæˆä¸åŒç‰¹å¾çš„æ•°æ®
                const baseValue = 100 + index * 50;
                record.values[pointName] = baseValue + Math.sin(i * 0.01 + index) * 30 + Math.random() * 20;
            });
            
            data.push(record);
        }
        
        console.log('ç”Ÿæˆäº†', data.length, 'æ¡æ•°æ®');
        console.log('ç¬¬ä¸€æ¡æ•°æ®:', data[0]);
        return data;
    }

    applyDownsampling() {
        if (this.allData.length <= 100) {
            // å¦‚æœæ•°æ®ç‚¹å¤ªå°‘ï¼Œä¸è¿›è¡Œé™é‡‡æ ·ï¼Œä½†éœ€è¦æ’å€¼æ¥æ˜¾ç¤ºæ›²çº¿
            this.displayData = this.interpolateData(this.allData, 100);
            this.hideDownsamplingInfo();
            return;
        }
        
        if (this.allData.length <= 2000) {
            this.displayData = this.allData;
            this.hideDownsamplingInfo();
            return;
        }

        // ä½¿ç”¨LTTBç®—æ³•è¿›è¡Œé™é‡‡æ ·
        const threshold = 1000; // ç›®æ ‡æ•°æ®ç‚¹æ•°
        this.displayData = this.lttbDownsample(this.allData, threshold);
        this.showDownsamplingInfo(this.allData.length, this.displayData.length);
    }

    // æ•°æ®æ’å€¼ï¼Œç”¨äºæ•°æ®ç‚¹å¤ªå°‘çš„æƒ…å†µ
    interpolateData(data, targetPoints) {
        if (data.length <= 2) return data;
        
        const interpolated = [];
        const step = (data.length - 1) / (targetPoints - 1);
        
        for (let i = 0; i < targetPoints; i++) {
            const index = Math.round(i * step);
            if (index < data.length) {
                interpolated.push(data[index]);
            }
        }
        
        return interpolated;
    }

    lttbDownsample(data, threshold) {
        if (data.length <= threshold) {
            return data;
        }

        const sampled = [];
        const bucketSize = Math.floor(data.length / threshold);
        
        // ç®€åŒ–çš„é™é‡‡æ ·ï¼šå‡åŒ€é‡‡æ ·
        for (let i = 0; i < data.length; i += bucketSize) {
            sampled.push(data[i]);
        }
        
        // ç¡®ä¿åŒ…å«æœ€åä¸€ä¸ªç‚¹
        if (sampled[sampled.length - 1] !== data[data.length - 1]) {
            sampled.push(data[data.length - 1]);
        }
        
        return sampled;
    }

    showDownsamplingInfo(originalCount, sampledCount) {
        console.log(`æ•°æ®é™é‡‡æ ·: ${originalCount} -> ${sampledCount}`);
    }

    hideDownsamplingInfo() {
        console.log('æ— éœ€é™é‡‡æ ·');
    }

    initChart() {
        const chartContainer = this.shadowRoot.getElementById('chartContainer');
        if (chartContainer && window.echarts) {
            // å…ˆé”€æ¯æ—§çš„å›¾è¡¨å®ä¾‹
            if (this.chart) {
                try {
                    this.chart.dispose();
                    this.chart = null;
                } catch (error) {
                    console.warn('é”€æ¯æ—§å›¾è¡¨å®ä¾‹æ—¶å‡ºé”™:', error);
                }
            }
            
            // å¦‚æœå®¹å™¨æ˜¾ç¤ºçš„æ˜¯ç©ºçŠ¶æ€ï¼Œæ¸…ç©ºå®ƒ
            if (chartContainer.querySelector('div[style*="ğŸ“Š"]')) {
                chartContainer.innerHTML = '';
            }
            
            // æ¸…é™¤åŠ è½½æç¤º
            const loadingEl = chartContainer.querySelector('.loading');
            if (loadingEl) {
                loadingEl.remove();
            }
            
            // ç­‰å¾…DOMå®Œå…¨æ¸²æŸ“ï¼Œä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿå’Œå¤šæ¬¡æ£€æŸ¥
            const tryInitChart = (attempt = 0) => {
                if (window.echarts && !this.chart) {
                    const rect = chartContainer.getBoundingClientRect();
                    console.log(`å°è¯•åˆå§‹åŒ–å›¾è¡¨ (ç¬¬${attempt + 1}æ¬¡):`, rect);
                    
                    // å¦‚æœé«˜åº¦å¤ªå°ï¼Œç»§ç»­ç­‰å¾…
                    if (rect.height < 100 && attempt < 5) {
                        setTimeout(() => tryInitChart(attempt + 1), 200);
                        return;
                    }
                    
                    // å¼ºåˆ¶è®¾ç½®æœ€å°é«˜åº¦
                    if (rect.height < 350) {
                        chartContainer.style.minHeight = '350px';
                    }
                    
                    try {
                        this.chart = window.echarts.init(chartContainer);
                        console.log('å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
                        this.updateChart();
                        console.log('å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
                    } catch (error) {
                        console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
                        setTimeout(() => tryInitChart(attempt + 1), 500);
                    }
                } else if (attempt < 10) {
                    setTimeout(() => tryInitChart(attempt + 1), 200);
                } else {
                    console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥ï¼šEChartsæœªåŠ è½½æˆ–å®¹å™¨æœªæ‰¾åˆ°');
                }
            };
            
            // å¼€å§‹å°è¯•åˆå§‹åŒ–
            setTimeout(() => tryInitChart(), 100);
        }
    }

    updateVisualization() {
        this.updateChart();
        this.updateTable();
    }

    updateChart() {
        if (!this.chart || !this.displayData.length || this.selectedPoints.size === 0) return;

        // æ£€æŸ¥æ˜¯å¦æœ‰Timeåˆ—å’Œæ˜¯å¦ä¸ºæ•°å€¼æ•°æ®
        const actualColumns = this.actualDataColumns || [];
        const hasTimeColumn = this.tableHeader && this.tableHeader.includes('Time'); // ç›´æ¥åˆ¤æ–­è¡¨å¤´æ˜¯å¦æœ‰Timeåˆ—
        const hasNumericData = this.displayData.some(record => {
            return actualColumns.some(column => {
                const value = record[column] !== undefined ? record[column] : record.values && record.values[column] !== undefined ? record.values[column] : null;
                return typeof value === 'number';
            });
        });

        // å¦‚æœæ²¡æœ‰Timeåˆ—æˆ–ä¸æ˜¯æ•°å€¼æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
        if (!hasTimeColumn || !hasNumericData) {
            console.log('æ²¡æœ‰Timeåˆ—æˆ–éæ•°å€¼æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯');
            const chartContainer = this.shadowRoot.getElementById('chartContainer');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
                        <div style="font-size: 14px; margin-bottom: 8px;">æ•°æ®ä¸é€‚åˆå›¾è¡¨æ˜¾ç¤º</div>
                        <div style="font-size: 12px;">${!hasTimeColumn ? 'ç¼ºå°‘æ—¶é—´åˆ—æ•°æ®' : 'æµ‹ç‚¹æ•°æ®ä¸ºéæ•°å€¼ç±»å‹'}</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #666;">è¯·é€‰æ‹©åŒ…å«æ—¶é—´åˆ—çš„æ•°å€¼å‹æµ‹ç‚¹</div>
                    </div>
                `;
            }
            return;
        }

        const series = [];
        const selectedPointsArray = Array.from(this.selectedPoints);
        // actualColumns å·²åœ¨ä¸Šé¢å£°æ˜ï¼Œç›´æ¥ä½¿ç”¨
        
        // åªä¸ºæ•°å€¼ç±»å‹çš„å®é™…æ•°æ®åˆ—åˆ›å»ºç³»åˆ—
        actualColumns.forEach((column, index) => {
            // æ£€æŸ¥è¯¥åˆ—æ˜¯å¦ä¸ºæ•°å€¼ç±»å‹
            const isNumericColumn = this.displayData.some(record => {
                const value = record[column] !== undefined ? record[column] : record.values && record.values[column] !== undefined ? record.values[column] : null;
                return typeof value === 'number';
            });
            
            if (!isNumericColumn) {
                console.log('è·³è¿‡éæ•°å€¼åˆ—:', column);
                return; // è·³è¿‡éæ•°å€¼åˆ—
            }
            
            const data = this.displayData.map(record => [
                record.timestamp,
                record[column] !== undefined ? record[column] : record.values && record.values[column] !== undefined ? record.values[column] : 0
            ]);
            
            const color = this.getColorForPoint(column);
            series.push({
                name: column,
                type: 'line',
                data: data,
                smooth: true,
                symbol: 'circle',
                symbolSize: 4,
                showSymbol: false,
                lineStyle: {
                    width: 2,
                    color: color
                },
                areaStyle: undefined // æ˜ç¡®ç¦ç”¨å¡«å……åŒºåŸŸ
            });
        });

        const option = {
            title: {
                text: 'æ•°æ®è¶‹åŠ¿',
                left: 'center',
                top: 10,
                textStyle: {
                    fontSize: 14,
                    fontWeight: 'bold'
                }
            },
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    if (!params || params.length === 0) return '';
                    
                    const time = new Date(params[0].value[0]).toLocaleString();
                    let result = `æ—¶é—´: ${time}<br/>`;
                    params.forEach(param => {
                        result += `${param.seriesName}: ${param.value[1].toFixed(2)}<br/>`;
                    });
                    return result;
                }
            },
            legend: {
                data: actualColumns, // ä½¿ç”¨å®é™…æ•°æ®åˆ—ä½œä¸ºå›¾ä¾‹
                top: 40,
                left: 'center',
                textStyle: {
                    fontSize: 12
                }
            },
            grid: {
                left: '8%',
                right: '8%',
                bottom: '20%',
                top: '20%'
            },
            xAxis: {
                type: 'time',
                axisLabel: {
                    formatter: function(value) {
                        return new Date(value).toLocaleString();
                    }
                }
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    formatter: function(value) {
                        return value.toFixed(2);
                    }
                }
            },
            dataZoom: [
                {
                    type: 'inside',
                    start: 0,
                    end: 100
                },
                {
                    start: 0,
                    end: 100,
                    handleStyle: {
                        backgroundColor: '#3370ff'
                    }
                }
            ],
            toolbox: {
                right: 20,
                feature: {
                    restore: {},
                    saveAsImage: {}
                }
            },
            series: series
        };

        try {
            this.chart.setOption(option, false); // ç¬¬äºŒä¸ªå‚æ•°falseè¡¨ç¤ºåˆå¹¶é€‰é¡¹ï¼Œé¿å…DOMé‡å»º
        } catch (error) {
            console.error('å›¾è¡¨æ›´æ–°å¤±è´¥:', error);
            // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–å›¾è¡¨
            this.initChart();
        }
    }

    updateTable() {
        console.log('æ›´æ–°è¡¨æ ¼ï¼ŒdisplayData length:', this.displayData.length);
        console.log('selectedPoints:', Array.from(this.selectedPoints));
        
        const tableSection = this.shadowRoot.querySelector('.table-section');
        const table = this.shadowRoot.getElementById('dataTable');
        const tbody = this.shadowRoot.getElementById('tableBody');
        
        // ç¡®ä¿è¡¨æ ¼åŒºåŸŸå§‹ç»ˆæ˜¾ç¤º
        if (tableSection) {
            tableSection.style.display = 'flex';
        }
        
        // æ›´æ–°è¡¨æ ¼æ•°æ®
        if (!tbody) {
            console.error('æ‰¾ä¸åˆ°è¡¨æ ¼ä½“');
            return;
        }
        
        tbody.innerHTML = '';
        
        if (!this.displayData.length || this.selectedPoints.size === 0) {
            console.log('æ²¡æœ‰æ˜¾ç¤ºæ•°æ®æˆ–æ²¡æœ‰é€‰ä¸­çš„æµ‹ç‚¹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º');
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            const actualColumns = this.actualDataColumns || Array.from(this.selectedPoints);
            td.colSpan = Math.max(1, actualColumns.length + 1); // æ—¶é—´åˆ— + å®é™…æ•°æ®åˆ—
            td.style.textAlign = 'center';
            td.style.color = '#999';
            td.style.padding = '60px 20px';
            td.style.fontSize = '14px';
            td.textContent = this.selectedPoints.size === 0 ? 'è¯·é€‰æ‹©æµ‹ç‚¹' : 'æš‚æ— æ•°æ®';
            tr.appendChild(td);
            tbody.appendChild(tr);
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯ä¸ºç©ºçŠ¶æ€
            this.totalPages = 0;
            this.currentPage = 1; // é‡ç½®å½“å‰é¡µ
            this.updatePagination();
            return;
        }

        // è®¡ç®—åˆ†é¡µ
        this.totalPages = Math.ceil(this.displayData.length / this.pageSize);
        // ç¡®ä¿å½“å‰é¡µåœ¨æœ‰æ•ˆèŒƒå›´å†…
        if (this.currentPage > this.totalPages) {
            this.currentPage = this.totalPages;
        }
        if (this.currentPage < 1) {
            this.currentPage = 1;
        }
        
        console.log('åˆ†é¡µä¿¡æ¯ï¼šå½“å‰é¡µ', this.currentPage, 'æ€»é¡µæ•°', this.totalPages, 'æ€»æ•°æ®', this.displayData.length);
        
        const startIndex = (this.currentPage - 1) * this.pageSize;
        const endIndex = Math.min(startIndex + this.pageSize, this.displayData.length);
        const pageData = this.displayData.slice(startIndex, endIndex);
        
        console.log('å½“å‰é¡µæ•°æ®èŒƒå›´:', startIndex, '-', endIndex, 'å®é™…æ•°æ®é‡:', pageData.length);
        
        const selectedPointsArray = Array.from(this.selectedPoints);
        const actualColumns = this.actualDataColumns || selectedPointsArray; // ä¼˜å…ˆä½¿ç”¨å®é™…æ•°æ®åˆ—
        
        pageData.forEach((record, index) => {
            const tr = document.createElement('tr');
            
            // æ—¶é—´åˆ—
            const timeTd = document.createElement('td');
            timeTd.textContent = new Date(record.timestamp).toLocaleString();
            tr.appendChild(timeTd);
            
            // å®é™…æ•°æ®åˆ—ï¼ˆä¸æ˜¯é€‰ä¸­æµ‹ç‚¹ï¼‰
            actualColumns.forEach(column => {
                const td = document.createElement('td');
                const value = record[column] !== undefined ? record[column] : record.values && record.values[column] !== undefined ? record.values[column] : '-';
                td.textContent = typeof value === 'number' ? value.toFixed(2) : value;
                tr.appendChild(td);
            });
            
            tbody.appendChild(tr);
        });
        
        console.log('è¡¨æ ¼æ•°æ®æ›´æ–°å®Œæˆï¼Œè¡Œæ•°:', tbody.children.length);

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        this.updatePagination();
    }

    updatePagination() {
        const pagination = this.shadowRoot.getElementById('tablePagination');
        if (pagination) {
            // è®¾ç½®åˆ†é¡µç»„ä»¶çš„æ•°æ®
            pagination.setAttribute('current-page', this.currentPage);
            pagination.setAttribute('page-size', this.pageSize);
            pagination.setAttribute('total-records', this.displayData.length);
        }
    }

    getColorForPoint(pointName) {
        // ä¸ºæ¯ä¸ªæµ‹ç‚¹åç§°ç”Ÿæˆå›ºå®šçš„é¢œè‰²
        const colors = [
            '#3370ff', '#00b42a', '#ff7d00', '#f53f3f', '#722ed1',
            '#13c2c2', '#eb2f96', '#faad14', '#a0d911', '#f5222d'
        ];
        
        // ä½¿ç”¨æµ‹ç‚¹åç§°çš„å“ˆå¸Œå€¼æ¥ç¡®ä¿é¢œè‰²ä¸€è‡´æ€§
        let hash = 0;
        for (let i = 0; i < pointName.length; i++) {
            hash = pointName.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        return colors[Math.abs(hash) % colors.length];
    }

    getColorForIndex(index) {
        const colors = [
            '#3370ff', '#00b42a', '#ff7d00', '#f53f3f', '#722ed1',
            '#13c2c2', '#eb2f96', '#faad14', '#a0d911', '#f5222d'
        ];
        return colors[index % colors.length];
    }

    // æ¨¡æ€æ¡†ç›¸å…³æ–¹æ³•
    showDataCleanModal() {
        this.showModal('æ•°æ®æ¸…ç†', `
            <div class="form-group">
                <label>æ¸…ç†è§„åˆ™ï¼š</label>
                <select id="cleanRule">
                    <option value="remove-duplicates">ç§»é™¤é‡å¤æ•°æ®</option>
                    <option value="remove-outliers">ç§»é™¤å¼‚å¸¸å€¼</option>
                    <option value="fill-missing">å¡«å……ç¼ºå¤±å€¼</option>
                </select>
            </div>
            <div class="form-group">
                <label>é˜ˆå€¼è®¾ç½®ï¼š</label>
                <input type="number" id="threshold" placeholder="è¾“å…¥é˜ˆå€¼" />
            </div>
        `, () => {
            const rule = this.shadowRoot.getElementById('cleanRule').value;
            const threshold = this.shadowRoot.getElementById('threshold').value;
            console.log('æ‰§è¡Œæ•°æ®æ¸…ç†:', rule, threshold);
            // è¿™é‡Œå®ç°å®é™…çš„æ•°æ®æ¸…ç†é€»è¾‘
        });
    }

    showImportModal() {
        this.showModal('å¯¼å…¥æ•°æ®', `
            <div class="form-group">
                <label class="form-label required">ç›®æ ‡å­˜å‚¨è·¯å¾„å‰ç¼€ï¼š</label>
                <input type="text" id="targetPath" class="form-input" placeholder="ä¾‹å¦‚ï¼šroot.sg.device" required>
                <div class="form-hint">æ•°æ®å°†å¯¼å…¥åˆ°æ­¤è·¯å¾„ä¸‹ï¼Œä¾‹å¦‚ï¼šroot.sg.device</div>
            </div>
            <div class="form-group">
                <label class="form-label required">é€‰æ‹©CSVæ–‡ä»¶ï¼š</label>
                <input type="file" id="importFile" class="form-input" accept=".csv" required>
                <div class="form-hint">ä»…æ”¯æŒCSVæ ¼å¼æ–‡ä»¶ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡1GB</div>
            </div>
        `, () => {
            this.handleImportData();
        });
    }

    async handleImportData() {
        const targetPath = this.shadowRoot.getElementById('targetPath').value.trim();
        const fileInput = this.shadowRoot.getElementById('importFile');
        const file = fileInput.files[0];

        // éªŒè¯è¾“å…¥
        if (!targetPath) {
            this.showMessage('è¯·è¾“å…¥ç›®æ ‡å­˜å‚¨è·¯å¾„å‰ç¼€', 'error');
            return;
        }

        if (!file) {
            this.showMessage('è¯·é€‰æ‹©è¦å¯¼å…¥çš„CSVæ–‡ä»¶', 'error');
            return;
        }

        if (!file.name.toLowerCase().endsWith('.csv')) {
            this.showMessage('ä»…æ”¯æŒCSVæ ¼å¼æ–‡ä»¶', 'error');
            return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ1GBï¼‰
        if (file.size > 1024 * 1024 * 1024) {
            this.showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡1GB', 'error');
            return;
        }

        try {
            // æ˜¾ç¤ºloading
            if (window.showGlobalLoading) {
                window.showGlobalLoading('æ­£åœ¨å¯¼å…¥æ•°æ®...');
            }

            // åˆ›å»ºFormData
            const formData = new FormData();
            
            // æ·»åŠ é…ç½®å‚æ•°ä½œä¸ºJSONå­—ç¬¦ä¸²
            const config = {
                targetPath: targetPath
            };
            formData.append('config', new Blob([JSON.stringify(config)], { type: 'application/json' }));
            
            // æ·»åŠ æ–‡ä»¶
            formData.append('file', file);

            // è°ƒç”¨å¯¼å…¥æ¥å£
            const response = await fetch(window.AppConfig.getApiUrl('data', 'import'), {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.code === 200) {
                this.showMessage(result.message || 'æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                // å¯¼å…¥æˆåŠŸååˆ·æ–°æ•°æ®
                this.loadData();
            } else {
                this.showMessage(result.message || 'æ•°æ®å¯¼å…¥å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
            this.showMessage('å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        } finally {
            // éšè—loading
            if (window.hideGlobalLoading) {
                window.hideGlobalLoading();
            }
        }
    }

    showExportModal() {
        this.showModal('å¯¼å‡ºæ•°æ®', `
            <div class="form-group">
                <label>å¯¼å‡ºæ ¼å¼ï¼š</label>
                <select id="exportFormat">
                    <option value="csv">CSVæ ¼å¼</option>
                    <option value="json">JSONæ ¼å¼</option>
                    <option value="excel">Excelæ ¼å¼</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ•°æ®èŒƒå›´ï¼š</label>
                <select id="exportRange">
                    <option value="current-page">å½“å‰é¡µ</option>
                    <option value="all">å…¨éƒ¨æ•°æ®</option>
                    <option value="selected">é€‰ä¸­æ•°æ®</option>
                </select>
            </div>
        `, () => {
            const format = this.shadowRoot.getElementById('exportFormat').value;
            const range = this.shadowRoot.getElementById('exportRange').value;
            console.log('å¯¼å‡ºæ•°æ®:', format, range);
            // è¿™é‡Œå®ç°å®é™…çš„æ•°æ®å¯¼å‡ºé€»è¾‘
        });
    }

    showModal(title, content, onConfirm) {
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="modal-close">Ã—</button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
                <div class="modal-footer">
                    <button class="modal-btn">å–æ¶ˆ</button>
                    <button class="modal-btn primary">ç¡®å®š</button>
                </div>
            </div>
        `;

        this.shadowRoot.appendChild(modalOverlay);

        const closeModal = () => {
            this.shadowRoot.removeChild(modalOverlay);
        };

        // ç»‘å®šäº‹ä»¶
        modalOverlay.querySelector('.modal-close').addEventListener('click', closeModal);
        modalOverlay.querySelector('.modal-btn:not(.primary)').addEventListener('click', closeModal);
        modalOverlay.querySelector('.modal-btn.primary').addEventListener('click', () => {
            if (onConfirm) onConfirm();
            closeModal();
        });

        // ç‚¹å‡»é®ç½©å…³é—­
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });
    }
}

// æ³¨å†Œè‡ªå®šä¹‰å…ƒç´ 
customElements.define('data-visualization', DataVisualization);
